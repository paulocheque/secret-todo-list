{% extends "../base.html" %}


{% block content %}
<div class="page-header">
  <h1>TODO list <small>tasks</small></h1>
</div>


<h2><small>New</small></h2>

<form id="form-create" action="/api/tasks" method="post" class="form-create form-inline" role="form">
    <div class="form-group">
        <label for="description">Task description</label>
        <input id="description" name="description" type="text" placeholder="add new task" class="input-xlarge form-control" required="" autocomplete="off" autofocus/>
    </div>
    <div class="form-group">
        <label for="due_date">Due date</label>
        <input id="due_date" name="due_date" type="text" placeholder="yyyy/mm/dd" class="input-medium form-control" autocomplete="off"/>
    </div>
    <div class="form-group">
        <label for="description">Priority</label>
        <select id="priority" name="priority" required="" class="input-small form-control">
            <option value="1">1</option>
            <option value="2" selected="selected">2</option>
            <option value="3">3</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary" style="vertical-align: bottom;">Add</button>
</form>


<h2><small>Tasks</small></h2>

<table id="table-list" class="table table-striped table-hover table-condensed table-responsive tablesorter" action="/api/tasks">
    <thead>
        <tr>
            <th>Completed</th>
            <th>Description</th>
            <th>Due date</th>
            <th>Priority</th>
            <th>Edit</th>
            <th>Delete</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

{% end %}


{% block js %}
    <script src="/static/js/jquery.rest.min.js"></script>
    <script src="/static/js/jquery.tablesorter.min.js"></script>

    <script language="JavaScript">
    var client = new $.RestClient('/api/');
    client.add('tasks', { stripTrailingSlash: true });

    function createUpdateTasksFormModal(lineId) {
        var formData = $("#" + lineId).getData();
        var modalId = "updateFormModal";
        var callbackSuccess = function(data, status) {
            $("#" + modalId).removeModal();
            var line = $("#" + data._id);
            line.refreshTableLine(function(data, status) {
                line.updateTableLine(data, [data.completed, data.description, data.due_date, data.priority]);
                line.fadeOut().fadeIn();
            });
        };
        var url = "/api/tasks/" + formData._id;
        var a = createInput("description", "Description", formData.description || "");
        var b = createInput("due_date", "Due date", formData.due_date || "");
        var c = createSelect("priority", "Priority", [{label: "1", value: "1"}, {label: "2", value: "2"}, {label: "3", value: "3"}], formData.priority || "");
        var formContent = $("<div/>").append(a).append(b).append(c);
        var modalObj = createModalWithForm(modalId, url, formContent, callbackSuccess);
        modalObj.modal();
    }

    function createTaskLine(data) {
        var updateButton = createUpdateButtonModal(function() {
            createUpdateTasksFormModal(data._id);
        });
        var deleteForm = createDeleteForm("/api/tasks/" + data._id + "/delete");
        var url = "/api/tasks/" + data._id;
        var completed = createCheckbox("completed", data.completed);
        completed.change(function() {
            var value = $(this).is(":checked");
            client.tasks.update(data._id, {completed:value});
        });
        $("#table-list").createTableLine(data, data._id, url, [completed, data.description, data.due_date, data.priority, updateButton, deleteForm]);
    }

    $(document).ready(function() {
        $(".form-create").asyncForm(function(data, status) {
            createTaskLine(data);
        });

        $("#table-list").populateTable(function(lines, status) {
            for (var i in lines) {
                var data = lines[i];
                createTaskLine(data);
            }
        });
        $("#table-list").tablesorter();
    });
  </script>
{% end %}
