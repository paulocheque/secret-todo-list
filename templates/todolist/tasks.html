{% extends "../base.html" %}


{% block content %}
<div class="page-header">
  <h1>TODO list <small>tasks</small></h1>
</div>


<h2><small>New</small></h2>

<form id="form-create" class="form-create form-inline" role="form">
    <div class="form-group">
        <label for="description">Task description</label>
        <input id="description" name="description" type="text" placeholder="add new task" class="input-xlarge form-control" required="" autocomplete="off" autofocus/>
    </div>
    <div class="form-group">
        <label for="due_date">Due date</label>
        <input id="due_date" name="due_date" type="text" placeholder="yyyy/mm/dd" class="input-medium form-control" autocomplete="off"/>
    </div>
    <div class="form-group">
        <label for="description">Priority</label>
        <select id="priority" name="priority" required="" class="input-small form-control">
            <option value="1">1</option>
            <option value="2" selected="selected">2</option>
            <option value="3">3</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary" style="vertical-align: bottom;">Add</button>
</form>


<h2><small>Tasks</small></h2>

<table id="table-list" class="table table-striped table-hover table-condensed table-responsive tablesorter">
    <thead>
        <tr>
            <th class="col-lg-1">Priority</th>
            <th class="col-lg-2">Due date</th>
            <th class="col-lg-6">Description</th>
            <th class="col-lg-1">Completed</th>
            <th class="col-lg-1">Edit</th>
            <th class="col-lg-1">Delete</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

{% end %}


{% block js %}
    <link href="/static/css/bootstrap-datepicker.css" rel="stylesheet">
    <script src="/static/js/bootstrap-datepicker.js"></script>

    <script language="JavaScript">
    var client = new SecretRestClient("{{ current_user.secret_key }}", "{{ current_user.id }}", "/api/todolist/{{ todolist_id }}/tasks", "1");

    var defaultErrorHandler = function(response, status) {
        $.pnotify({
            type: 'notice',
            delay: 3000,
            title: 'Invalid action',
            text: 'Could not retrieve server data right now'
        });
    };

    function createUpdateTasksFormModal(lineId) {
        var formData = $("#" + lineId).getData();
        var modalId = "updateFormModal";
        var a = createInput("description", "Description", formData.description || "");
        var b = createInput("due_date", "Due date", formData.due_date || "");
        var c = createSelect("priority", "Priority", [{label: "1", value: "1"}, {label: "2", value: "2"}, {label: "3", value: "3"}], formData.priority || "");
        var formContent = $("<div/>").append(a).append(b).append(c);
        var objs = createModalWithForm2(modalId, formContent);
        var modalObj = objs[0];
        var updateForm = objs[1];
        updateForm.on('submit', function (e) {
            e.preventDefault();
            var success = function(response, status) {
                $("#" + modalId).removeModal();
                var line = $("#" + response._id);
                client.read(lineId, function(data, status) {
                    var completed = createCheckbox("completed", data.completed);
                    line.updateTableLine(data, [data.priority, data.due_date, linkify(data.description), completed]);
                    line.fadeOut().fadeIn();
                });
            };
            var data = {};
            $(this).serializeArray().map(function(x){ data[x.name] = htmlEscape(x.value); });
            client.update(lineId, data, success, defaultErrorHandler);
        });
        modalObj.modal();
    }

    function createTaskLine(data) {
        var updateButton = createUpdateButtonModal(function() {
            createUpdateTasksFormModal(data._id);
        });
        var deleteForm = createDeleteForm2();
        deleteForm.on('submit', function (e) {
            e.preventDefault();
            var success = function(response, status) {
                deleteForm.closest("tr").deleteTableLine();
            };
            client.del(data._id, success, defaultErrorHandler);
        });

        var url = "/api/tasks/" + data._id;
        var completed = createCheckbox("completed", data.completed);
        completed.change(function() {
            var value = $(this).is(":checked");
            client.update(data._id, {completed:value});
        });
        $("#table-list").createTableLine(data, data._id, url, [data.priority, data.due_date, linkify(data.description), completed, updateButton, deleteForm]);
    }

    $(document).ready(function() {
        $(".form-create").on('submit', function (e) {
            e.preventDefault();
            var data = {};
            $(this).serializeArray().map(function(x){ data[x.name] = htmlEscape(x.value); });
            var success = function(response, status) {
                createTaskLine(response);
                $(".form-create").each(function(){ this.reset(); });
            };
            client.create(data, success, defaultErrorHandler);
        });

        client.list(0, 50, function(lines, status) {
            for (var i in lines) {
                var data = lines[i];
                createTaskLine(data);
            }
        }, defaultErrorHandler);

        var textExtraction = function(node) {
            if (node.innerHTML.startsWith("<input")) {
                if(node.innerHTML.contains("checked")) {
                    return "1";
                } else {
                    return "0";
                }
            } else {
                return node.innerHTML;
            }
        }
        $("#table-list").tablesorter({textExtraction:textExtraction});
        // $('#priority').spinner({min:1, max:3});
        $('#due_date').datepicker({format: "yyyy/mm/dd"});
    });
  </script>
{% end %}
