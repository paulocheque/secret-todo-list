{% extends "../base.html" %}


{% block content %}
<div class="page-header">
  <h1>TODO lists <small>management</small></h1>
</div>


<h2><small>New</small></h2>

<form id="form-create" class="form-create form-inline" role="form">
    <div class="form-group">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" placeholder="add new todo list" class="input-xlarge form-control" required="" autocomplete="off" autofocus/>
    </div>
    <button type="submit" class="btn btn-primary" style="vertical-align: bottom;">Add</button>
</form>


<h2><small>TODO lists</small></h2>

<table id="table-list" class="table table-striped table-hover table-condensed table-responsive tablesorter">
    <thead>
        <tr>
            <th class="col-lg-8">Name</th>
            <th class="col-lg-2"># tasks</th>
            <th class="col-lg-1">Edit</th>
            <th class="col-lg-1">Delete</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

{% end %}


{% block js %}
    <script language="JavaScript">
    var client = new SecretRestClient("{{ current_user.secret_key }}", "{{ current_user.id }}", "/api/todolists", "1");

    var defaultErrorHandler = function(response, status) {
        $.pnotify({
            type: 'notice',
            delay: 3000,
            title: 'Invalid action',
            text: 'Could not retrieve server data right now'
        });
    };

    function createUpdateTasksFormModal(lineId) {
        var formData = $("#" + lineId).getData();
        var modalId = "updateFormModal";
        var a = createInput("name", "Name", formData.name || "");
        var formContent = $("<div/>").append(a);
        var objs = createModalWithForm2(modalId, formContent);
        var modalObj = objs[0];
        var updateForm = objs[1];
        updateForm.on('submit', function (e) {
            e.preventDefault();
            var success = function(response, status) {
                $("#" + modalId).removeModal();
                var line = $("#" + response._id);
                client.read(lineId, function(data, status) {
                    var linkName = createLink("/todolist/" + data._id + "/tasks", data.name);
                    line.updateTableLine(data, [linkName]);
                    line.fadeOut().fadeIn();
                });
            };
            var data = {};
            $(this).serializeArray().map(function(x){ data[x.name] = htmlEscape(x.value); });
            client.update(lineId, data, success, defaultErrorHandler);
        });
        modalObj.modal();
    }

    function createTaskLine(data) {
        var updateButton = createUpdateButtonModal(function() {
            createUpdateTasksFormModal(data._id);
        });
        var deleteForm = createDeleteForm2();
        deleteForm.on('submit', function (e) {
            e.preventDefault();
            var success = function(response, status) {
                deleteForm.closest("tr").deleteTableLine();
            };
            client.del(data._id, success, defaultErrorHandler);
        });

        var url = "/api/todolists/" + data._id;
        var linkName = createLink("/todolist/" + data._id + "/tasks", data.name);
        $("#table-list").createTableLine(data, data._id, url, [linkName, "", updateButton, deleteForm]);
    }

    $(document).ready(function() {
        $(".form-create").on('submit', function (e) {
            e.preventDefault();
            var data = {};
            $(this).serializeArray().map(function(x){ data[x.name] = htmlEscape(x.value); });
            var success = function(response, status) {
                createTaskLine(response);
                $(".form-create").each(function(){ this.reset(); });
            };
            client.create(data, success, defaultErrorHandler);
        });

        client.list(0, 50, function(lines, status) {
            for (var i in lines) {
                var data = lines[i];
                createTaskLine(data);
            }
        }, defaultErrorHandler);

        $("#table-list").tablesorter();
    });
  </script>
{% end %}
